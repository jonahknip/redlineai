<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanSet Review Agent | Powered by RedlineAI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='none' stroke='%231B365D' stroke-width='4'/><rect x='20' y='25' width='18' height='24' fill='%23C8102E'/><rect x='20' y='51' width='18' height='24' fill='%23C8102E'/><rect x='40' y='25' width='40' height='24' fill='%23C8102E'/><rect x='40' y='51' width='18' height='24' fill='%23C8102E'/></svg>">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #E3F2FD;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
        }

        h1 {
            color: #1A1A1A;
            font-size: 2rem;
            font-weight: 700;
        }

        h1 span {
            color: #C8102E;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .brand {
            color: #C8102E;
            font-weight: 600;
            font-size: 0.85rem;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            border-bottom: none;
        }

        .tab {
            padding: 12px 24px;
            background: #ddd;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #ccc;
        }

        .tab.active {
            background: white;
            color: #1B365D;
            border-top: 3px solid #C8102E;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
            border-top: 4px solid #C8102E;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section h2 {
            font-size: 1.1rem;
            color: #1A1A1A;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section h2 .icon {
            color: #C8102E;
            font-size: 1.3rem;
        }

        .input-section label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            color: #999;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        input[type="text"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #C8102E;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-label {
            display: block;
            padding: 25px 15px;
            border: 2px dashed #ccc;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #F5F5F5;
            color: #666;
        }

        .file-label:hover {
            border-color: #C8102E;
            background: #FFF5F5;
        }

        .file-label.dragover {
            border-color: #C8102E;
            background: #FFF0F0;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #1A1A1A;
            font-weight: 500;
        }

        .btn {
            display: inline-block;
            padding: 14px 30px;
            background: #C8102E;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: #A00D25;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
        }

        .btn-secondary {
            background: #1B365D;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #132744;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #C8102E;
            color: #C8102E;
        }

        .btn-outline:hover:not(:disabled) {
            background: #C8102E;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }

        .status.loading {
            display: block;
            background: #FFF5F5;
            color: #C8102E;
            border: 1px solid #C8102E;
        }

        .status.error {
            display: block;
            background: #FFF0F0;
            color: #C8102E;
            border: 1px solid #C8102E;
        }

        .status.success {
            display: block;
            background: #F0FFF0;
            color: #2E7D32;
            border: 1px solid #2E7D32;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #C8102E;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .report-section {
            display: none;
        }

        .report-section.visible {
            display: block;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .report-header h2 {
            color: #1A1A1A;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .report-content {
            background: #ffffff;
            color: #333;
            padding: 30px 40px;
            border-radius: 6px;
            font-family: 'Segoe UI', 'Calibri', -apple-system, sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 700px;
            overflow-y: auto;
            border: 1px solid #ddd;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .report-content.plain-text {
            background: #1A1A1A;
            color: #E8E8E8;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            padding: 20px;
        }

        /* Professional report styling */
        .report-content h1 {
            color: #1B365D;
            font-size: 1.5rem;
            border-bottom: 3px solid #C8102E;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .report-content h2 {
            color: #1B365D;
            font-size: 1.2rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .report-content h3 {
            color: #333;
            font-size: 1rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .report-content th,
        .report-content td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
        }

        .report-content th {
            background: #f5f5f5;
            font-weight: 600;
            color: #1B365D;
        }

        .report-content tr:nth-child(even) {
            background: #fafafa;
        }

        .report-content ul,
        .report-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .report-content li {
            margin: 5px 0;
        }

        .report-content .critical,
        .report-content .red {
            color: #C8102E;
            font-weight: 600;
        }

        .report-content .warning,
        .report-content .orange {
            color: #E67E22;
            font-weight: 600;
        }

        .report-content .success,
        .report-content .green {
            color: #27AE60;
            font-weight: 600;
        }

        .report-content input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .info-box {
            background: #F5F5F5;
            border-left: 4px solid #C8102E;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }

        .info-box h3 {
            color: #1A1A1A;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-box p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-box code {
            background: #E8E8E8;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85rem;
            color: #C8102E;
        }

        /* Options section */
        .options-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .options-row {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
        }

        /* History section */
        .history-list {
            list-style: none;
            padding: 0;
        }

        .history-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #C8102E;
            background: #FFF5F5;
        }

        .history-item h4 {
            color: #1B365D;
            margin-bottom: 5px;
        }

        .history-item p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Email modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #1B365D;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        footer {
            text-align: center;
            color: #999;
            font-size: 0.85rem;
            margin-top: 30px;
        }

        footer a {
            color: #C8102E;
            text-decoration: none;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .card, .tab-content { padding: 20px; }
            .tabs { overflow-x: auto; }
            .tab { padding: 10px 16px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="46" fill="none" stroke="#1B365D" stroke-width="4"/>
                    <rect x="20" y="25" width="18" height="24" fill="#C8102E"/>
                    <rect x="20" y="51" width="18" height="24" fill="#C8102E"/>
                    <rect x="40" y="25" width="40" height="24" fill="#C8102E"/>
                    <rect x="40" y="51" width="18" height="24" fill="#C8102E"/>
                </svg>
                <h1>PlanSet <span>Review</span> Agent</h1>
            </div>
            <p class="subtitle">AI-Powered Civil Engineering Plan Review</p>
            <p class="brand">ABONMARCHE &bull; Powered by <strong style="color: #C8102E;">RedlineAI</strong></p>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="review">New Review</button>
            <button class="tab" data-tab="history">History</button>
        </div>

        <!-- New Review Tab -->
        <div class="tab-content active" id="tab-review">
            <div class="info-box">
                <h3>How to use</h3>
                <p><strong>Option 1:</strong> Upload a PDF planset directly</p>
                <p><strong>Option 2:</strong> Paste a OneDrive or SharePoint sharing link</p>
                <p>Supported formats: <code>.pdf</code></p>
            </div>

            <form id="reviewForm">
                <div class="input-section">
                    <h2><span class="icon">&#128279;</span> Paste OneDrive/SharePoint Link</h2>
                    <input type="text" id="urlInput" name="url" 
                           placeholder="https://company.sharepoint.com/... or https://1drv.ms/...">
                </div>

                <div class="divider">OR</div>

                <div class="input-section">
                    <h2><span class="icon">&#128196;</span> Upload PDF File</h2>
                    <input type="file" id="fileInput" name="file" accept=".pdf" style="display:none;">
                    <div class="file-label" id="fileLabel">
                        <span>Click to select or drag & drop PDF here</span>
                    </div>
                    <div class="file-name" id="fileName"></div>
                </div>

                <div class="divider">OPTIONS</div>

                <div class="options-row">
                    <div class="input-section">
                        <label for="checklistSelect">Review Checklist</label>
                        <select id="checklistSelect" name="checklist">
                            <option value="">Standard Review</option>
                            <option value="standard">Standard Civil Review</option>
                            <option value="mdot">MDOT Project Review</option>
                            <option value="municipal">Municipal Infrastructure</option>
                        </select>
                    </div>
                    <div class="input-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useVision" name="use_vision" checked>
                            Use AI Vision Analysis (analyzes sheet images)
                        </label>
                    </div>
                </div>

                <div class="input-section">
                    <label for="instructions">Custom Instructions (optional)</label>
                    <textarea id="instructions" name="instructions" 
                              placeholder="Add any specific instructions for the review agent...&#10;&#10;Examples:&#10;- Focus on drainage and erosion control&#10;- Check for ADA compliance&#10;- Verify all utility crossings&#10;- Look for conflicts with existing structures"></textarea>
                </div>

                <button type="submit" class="btn btn-block" id="submitBtn">
                    Review Planset
                </button>
            </form>

            <div class="status" id="status"></div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
            <h2 style="margin-bottom: 20px;">Review History</h2>
            <div id="historyList">
                <div class="empty-state">
                    <p>No review history yet.</p>
                    <p>Your reviews will appear here after you analyze a planset.</p>
                </div>
            </div>
        </div>

        <!-- Report Section -->
        <div class="card report-section" id="reportSection">
            <div class="report-header">
                <h2>Review Report</h2>
                <div class="report-actions">
                    <button class="btn btn-secondary btn-sm" id="copyBtn">Copy</button>
                    <button class="btn btn-secondary btn-sm" id="exportWordBtn">Export Word</button>
                    <button class="btn btn-secondary btn-sm" id="exportPdfBtn">Export PDF</button>
                    <button class="btn btn-outline btn-sm" id="emailBtn">Email Report</button>
                </div>
            </div>
            <div class="report-content" id="reportContent"></div>
        </div>

        <footer>
            <p>Powered by <a href="https://redlineai.co" target="_blank" style="font-weight: 600;">RedlineAI</a> &bull; Built for Abonmarche</p>
            <p>Questions? Contact <a href="https://teams.microsoft.com/l/chat/0/0?users=jknip@abonmarche.com" target="_blank">Jonah Knip</a></p>
        </footer>
    </div>

    <!-- Email Modal -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <h3>Email Report</h3>
            <div class="input-section">
                <label for="emailTo">Recipient Email</label>
                <input type="email" id="emailTo" placeholder="recipient@example.com">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="emailCancel">Cancel</button>
                <button class="btn" id="emailSend">Send Email</button>
            </div>
        </div>
    </div>

    <script>
        // Elements
        const form = document.getElementById('reviewForm');
        const urlInput = document.getElementById('urlInput');
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const fileName = document.getElementById('fileName');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const reportSection = document.getElementById('reportSection');
        const reportContent = document.getElementById('reportContent');
        const copyBtn = document.getElementById('copyBtn');
        const exportWordBtn = document.getElementById('exportWordBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const emailBtn = document.getElementById('emailBtn');
        const emailModal = document.getElementById('emailModal');
        const historyList = document.getElementById('historyList');

        // Current report data
        let currentReport = null;
        let currentProjectName = '';

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                
                if (tab.dataset.tab === 'history') {
                    loadHistory();
                }
            });
        });

        // File input handling
        fileLabel.addEventListener('click', function(e) {
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
                urlInput.value = '';
            } else {
                fileName.textContent = '';
            }
        });

        // Drag and drop
        fileLabel.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileLabel.addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });

        fileLabel.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = e.dataTransfer.files[0].name;
                urlInput.value = '';
            }
        });

        // Clear file if URL entered
        urlInput.addEventListener('input', function() {
            if (this.value.trim()) {
                fileInput.value = '';
                fileName.textContent = '';
            }
        });

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const url = urlInput.value.trim();
            const file = fileInput.files[0];

            if (!url && !file) {
                showStatus('error', 'Please provide a URL or upload a PDF file.');
                return;
            }

            const formData = new FormData();
            if (url) {
                formData.append('url', url);
            } else {
                formData.append('file', file);
            }

            // Add options
            formData.append('use_vision', document.getElementById('useVision').checked);
            formData.append('checklist', document.getElementById('checklistSelect').value);
            formData.append('instructions', document.getElementById('instructions').value);

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            showStatus('loading', '<span class="spinner"></span>Analyzing planset with AI Vision... This may take 1-2 minutes.');
            reportSection.classList.remove('visible');

            try {
                const response = await fetch('/api/review', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('success', `Analysis complete! Reviewed ${data.page_count} pages.`);
                    
                    currentReport = data.report;
                    currentProjectName = data.project_name || 'Planset Review';
                    
                    // Check if report is HTML or plain text
                    if (data.is_html) {
                        reportContent.innerHTML = data.report;
                        reportContent.classList.remove('plain-text');
                    } else {
                        reportContent.textContent = data.report;
                        reportContent.classList.add('plain-text');
                    }
                    
                    reportSection.classList.add('visible');
                    reportSection.scrollIntoView({ behavior: 'smooth' });
                    
                    // Save to history
                    saveToHistory(data);
                } else {
                    showStatus('error', `Error: ${data.error}`);
                }
            } catch (error) {
                showStatus('error', `Network error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Review Planset';
            }
        });

        // Copy to clipboard
        copyBtn.addEventListener('click', async function() {
            const text = reportContent.innerText || reportContent.textContent;
            
            try {
                if (reportContent.innerHTML && !reportContent.classList.contains('plain-text')) {
                    const blob = new Blob([reportContent.innerHTML], { type: 'text/html' });
                    const textBlob = new Blob([text], { type: 'text/plain' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob,
                        'text/plain': textBlob
                    });
                    await navigator.clipboard.write([clipboardItem]);
                } else {
                    await navigator.clipboard.writeText(text);
                }
                this.textContent = 'Copied!';
                setTimeout(() => { this.textContent = 'Copy'; }, 2000);
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                this.textContent = 'Copied!';
                setTimeout(() => { this.textContent = 'Copy'; }, 2000);
            }
        });

        // Export to Word
        exportWordBtn.addEventListener('click', async function() {
            if (!currentReport) return;
            
            this.textContent = 'Exporting...';
            this.disabled = true;
            
            try {
                const response = await fetch('/api/export/word', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report: currentReport,
                        project_name: currentProjectName
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentProjectName.replace(/\s+/g, '_')}_Review.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Export failed. Please try again.');
                }
            } catch (err) {
                alert('Export error: ' + err.message);
            } finally {
                this.textContent = 'Export Word';
                this.disabled = false;
            }
        });

        // Export to PDF
        exportPdfBtn.addEventListener('click', async function() {
            if (!currentReport) return;
            
            this.textContent = 'Exporting...';
            this.disabled = true;
            
            try {
                const response = await fetch('/api/export/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report: currentReport,
                        project_name: currentProjectName
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentProjectName.replace(/\s+/g, '_')}_Review.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Export failed. Please try again.');
                }
            } catch (err) {
                alert('Export error: ' + err.message);
            } finally {
                this.textContent = 'Export PDF';
                this.disabled = false;
            }
        });

        // Email modal
        emailBtn.addEventListener('click', () => {
            emailModal.classList.add('visible');
        });

        document.getElementById('emailCancel').addEventListener('click', () => {
            emailModal.classList.remove('visible');
        });

        document.getElementById('emailSend').addEventListener('click', async () => {
            const email = document.getElementById('emailTo').value.trim();
            if (!email) {
                alert('Please enter an email address.');
                return;
            }
            
            try {
                const response = await fetch('/api/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        report: currentReport,
                        project_name: currentProjectName
                    })
                });
                
                const data = await response.json();
                if (data.success && data.mailto_link) {
                    window.location.href = data.mailto_link;
                    emailModal.classList.remove('visible');
                } else {
                    alert(data.error || 'Failed to send email.');
                }
            } catch (err) {
                alert('Email error: ' + err.message);
            }
        });

        // Close modal on overlay click
        emailModal.addEventListener('click', (e) => {
            if (e.target === emailModal) {
                emailModal.classList.remove('visible');
            }
        });

        // History functions
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    historyList.innerHTML = '<ul class="history-list">' + 
                        data.history.map(item => `
                            <li class="history-item" data-id="${item.id}">
                                <h4>${item.project_name}</h4>
                                <p>${new Date(item.timestamp).toLocaleString()} &bull; ${item.page_count} pages</p>
                            </li>
                        `).join('') + '</ul>';
                    
                    // Add click handlers
                    document.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', () => loadReview(item.dataset.id));
                    });
                } else {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <p>No review history yet.</p>
                            <p>Your reviews will appear here after you analyze a planset.</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        async function loadReview(reviewId) {
            try {
                const response = await fetch(`/api/history/${reviewId}`);
                const data = await response.json();
                
                if (data.success && data.review) {
                    const review = data.review;
                    currentReport = review.report;
                    currentProjectName = review.project_name;
                    
                    if (review.is_html) {
                        reportContent.innerHTML = review.report;
                        reportContent.classList.remove('plain-text');
                    } else {
                        reportContent.textContent = review.report;
                        reportContent.classList.add('plain-text');
                    }
                    
                    reportSection.classList.add('visible');
                    
                    // Switch to review tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelector('[data-tab="review"]').classList.add('active');
                    document.getElementById('tab-review').classList.add('active');
                    
                    reportSection.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (err) {
                console.error('Failed to load review:', err);
            }
        }

        async function saveToHistory(data) {
            try {
                await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_name: data.project_name || 'Unknown Project',
                        page_count: data.page_count,
                        report: data.report,
                        is_html: data.is_html,
                        data: data.data
                    })
                });
            } catch (err) {
                console.error('Failed to save to history:', err);
            }
        }

        function showStatus(type, message) {
            status.className = 'status ' + type;
            status.innerHTML = message;
        }
    </script>
</body>
</html>
